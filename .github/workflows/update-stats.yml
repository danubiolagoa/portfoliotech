name: Update GitHub Stats

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  push:
    branches: [ main, master ]
  workflow_dispatch: # Allows manual trigger

permissions:
  contents: write

jobs:
  update-stats:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Fetch GitHub Contribution Data
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
        GITHUB_USERNAME: danubiolagoa
      run: |
        node -e "
        const https = require('https');
        const fs = require('fs');
        
        async function run() {
          const username = process.env.GITHUB_USERNAME;
          const token = process.env.GH_TOKEN;
          
          const query = {
            query: \`query {
              user(login: \"\${username}\") {
                contributionsCollection {
                  contributionCalendar {
                    totalContributions
                    weeks {
                      contributionDays {
                        contributionCount
                        date
                      }
                    }
                  }
                }
              }
            }\`
          };
          
          const options = {
            hostname: 'api.github.com',
            path: '/graphql',
            method: 'POST',
            headers: {
              'Authorization': \`Bearer \${token}\`,
              'Content-Type': 'application/json',
              'User-Agent': 'NodeJS'
            }
          };
          
          const req = https.request(options, (res) => {
            let data = '';
            res.on('data', d => data += d);
            res.on('end', () => {
              try {
                const result = JSON.parse(data);
                if (result.errors) throw new Error(JSON.stringify(result.errors));
                const calendar = result.data.user.contributionsCollection.contributionCalendar;
                const stats = {
                  updatedAt: new Date().toISOString(),
                  totalContributions: calendar.totalContributions,
                  weeks: calendar.weeks.map(w => w.contributionDays.map(d => ({
                    date: d.date,
                    count: d.contributionCount,
                    level: d.contributionCount > 0 ? Math.min(Math.ceil(d.contributionCount / 3), 4) : 0
                  })))
                };
                fs.writeFileSync('github-stats.json', JSON.stringify(stats, null, 2));
                console.log('Stats updated successfully');
              } catch (e) {
                console.error(e);
                process.exit(1);
              }
            });
          });
          req.on('error', e => { console.error(e); process.exit(1); });
          req.write(JSON.stringify(query));
          req.end();
        }
        run();
        "
    
    - name: Commit and Push
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add github-stats.json
        git diff --quiet && git diff --staged --quiet || (git commit -m "data: update github stats [skip ci]" && git push)
